trigger:
  branches:
    include:
    - main
    - feature/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: nodeVersion
    value: '22.x'

stages:
- stage: BuildAndTest
  displayName: 'Build'
  jobs:
  - job: Build
    displayName: 'Build Package'
    steps:
    - task: NodeTool@0
      displayName: 'Use Node.js $(nodeVersion)'
      inputs:
        versionSpec: '$(nodeVersion)'
    
    - task: Cache@2
      displayName: 'Cache node_modules'
      inputs:
        key: 'npm | "$(Agent.OS)" | package-lock.json'
        restoreKeys: |
          npm | "$(Agent.OS)"
          npm
        path: 'node_modules'
    
    - script: npm ci
      displayName: 'Install dependencies'
    
    - script: npm run build
      displayName: 'Build TypeScript'
    
    - script: npm pack
      displayName: 'Create NPM package'
    
    - script: |
        echo "Current directory: $(pwd)"
        echo "Build.SourcesDirectory: $(Build.SourcesDirectory)"
        echo "Files in current directory:"
        ls -la
        echo "Looking for .tgz files:"
        ls -la *.tgz || echo "No .tgz files found"
        echo "Files in Build.SourcesDirectory:"
        ls -la $(Build.SourcesDirectory)
        echo "Looking for .tgz files in Build.SourcesDirectory:"
        ls -la $(Build.SourcesDirectory)/*.tgz || echo "No .tgz files found in Build.SourcesDirectory"
      displayName: 'Debug: List files and locate .tgz'
    
    - script: |
        tgz_file=$(ls *.tgz)
        echo "##vso[task.setvariable variable=TGZ_FILE]$tgz_file"
        echo "Found .tgz file: $tgz_file"
      displayName: 'Get .tgz filename'
    
    - task: PublishPipelineArtifact@1
      displayName: 'Publish NPM package to artifacts'
      inputs:
        targetPath: '$(Build.SourcesDirectory)/$(TGZ_FILE)'
        artifact: 'npm-package'

# - stage: PublishPackage
#   displayName: 'Publish to NPM'
#   dependsOn: BuildAndTest
#   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
#   jobs:
#   - job: Publish
#     displayName: 'Publish to NPM'
#     steps:
#     - task: NodeTool@0
#       displayName: 'Use Node.js $(nodeVersion)'
#       inputs:
#         versionSpec: '$(nodeVersion)'
#     
#     - script: npm ci
#       displayName: 'Install dependencies'
#     
#     - script: npm run build
#       displayName: 'Build package'
#     
#     - script: |
#         npm pack
#         files=( ./*.tgz )
#         npm publish "${files[0]}" --tag alpha
#       env:
#         NPM_TOKEN: $(NPM_TOKEN)
#       displayName: 'Pack and publish to NPM'